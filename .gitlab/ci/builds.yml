GCC 9 Release:
  stage: build
  image: cbachhuber/tmiv-clang:2
  tags: [ linux ]
  before_script:
    - export CXX=/usr/lib/ccache/g++
    - export CC=/usr/lib/ccache/gcc
  script:
    - mkdir -p build && cd build
    - >
      cmake -DCMAKE_CXX_FLAGS="-Wall -Wextra -Wpedantic -Werror -Wfloat-conversion"
      -DENABLE_CLANG_TIDY=OFF -DCMAKE_BUILD_TYPE=Release
      -DNO_INTERNET=ON
      -DLOCAL_CATCH2_DIR=/dependencies/Catch2-2_13_4/
      -DLOCAL_FMT_DIR=/dependencies/fmt-7_0_3/
      -DLOCAL_HM_DIR=/dependencies/HM-16_16/
      -DLOCAL_VVDEC_DIR=/dependencies/vvdec-1_0_1/
      -DLOCAL_VVENC_DIR=/dependencies/vvenc-0_3_1_0/
      ..
    - make -j $(nproc)
    - make -j $(nproc) test

Clang 12 Debug:
  stage: build
  image: cbachhuber/tmiv-clang:2
  tags: [ linux, long-job ]
  script:
    - mkdir -p build && cd build
    - >
      cmake
      -DCMAKE_CXX_FLAGS="-stdlib=libc++
      -Wall -Wextra -Wpedantic -Werror -Wunreachable-code-aggressive -Wimplicit-int-conversion
      -fprofile-arcs -ftest-coverage"
      -DCMAKE_BUILD_TYPE=Debug
      -DNO_INTERNET=ON
      -DLOCAL_CATCH2_DIR=/dependencies/Catch2-2_13_4/
      -DLOCAL_FMT_DIR=/dependencies/fmt-7_0_3/
      -DLOCAL_HM_DIR=/dependencies/HM-16_16/
      -DLOCAL_VVDEC_DIR=/dependencies/vvdec-1_0_1/
      -DLOCAL_VVENC_DIR=/dependencies/vvenc-0_3_1_0/
      ..
    - make -j $(nproc)
    - make -j $(nproc) test
    - cd ..
    - mkdir coverage_html
    - >
      gcovr build --gcov-executable 'llvm-cov-12 gcov' -f 'source/' -e '.*\.test\.cpp'
      --xml coverage.xml --xml-pretty --html-details coverage_html/index.html --print-summary
  artifacts:
    reports:
      cobertura: coverage.xml
    paths:
      - coverage_html/
    expire_in: 5 days

VC 16 Release:
  stage: build
  image: buildtools2019:2021.05.18
  tags: [ windows ]
  cache:
    paths:
      - build
  script:
    - python -c "import os; os.makedirs('build', exist_ok=True)"
    - cd build
    - >
      cmake -G "Visual Studio 16 2019" -DENABLE_CLANG_TIDY=OFF
      -DBUILD_TAppEncoder=TRUE -DBUILD_TAppDecoder=TRUE
      -DCMAKE_CXX_FLAGS="/DWIN32 /D_WINDOWS /permissive- /w14640 /W4 /GR /EHsc /WX"
      -DCMAKE_INSTALL_PREFIX=/builds/software/MPEG/MIV/RS/TM1/install
      -DNO_INTERNET=ON
      -DLOCAL_CATCH2_DIR=/dependencies/Catch2-2_13_4/
      -DLOCAL_FMT_DIR=/dependencies/fmt-7_0_3/
      -DLOCAL_HM_DIR=/dependencies/HM-16_16/
      -DLOCAL_VVDEC_DIR=/dependencies/vvdec-1_0_1/
      -DLOCAL_VVENC_DIR=/dependencies/vvenc-0_3_1_0/
      ..
    - 'cmake --build . --parallel --config Release --target ALL_BUILD'
    - 'cmake --build . --config Release --target RUN_TESTS'
    - 'cmake --build . --config Release --target INSTALL'
  artifacts:
    expire_in: 1 day
    paths:
      - install/bin
      - install/include/TMIV/Decoder/MivDecoder.h
