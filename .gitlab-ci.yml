stages:
  - build
  - upload
  - release

.build_rules_template: &build_rules_definition
  stage: build
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - .clang-format
        - .clang-tidy
        - .gitlab-ci.yml
        - "**/CMakeLists.txt"
        - "**/*.cmake"
        - "**/*.cmake.in"
        - "**/*.cpp"
        - "**/*.h"
        - "**/*.hpp"

default:
  interruptible: true

GCC 9 Release:
  <<: *build_rules_definition
  image: rikorose/gcc-cmake:gcc-9
  tags:
    - linux
  script:
    - mkdir -p build && cd build
    - cmake -DCMAKE_CXX_FLAGS="-Wall -Wextra -Wpedantic -Werror" -DENABLE_CLANG_TIDY=OFF -DCMAKE_BUILD_TYPE=Release ..
    - make -j $(nproc)
    - make -j $(nproc) test

Clang 11 Debug:
  <<: *build_rules_definition
  image: cbachhuber/clang:11
  tags:
    - linux
  script:
    - mkdir -p build && cd build
    - >
      cmake
      -DCMAKE_CXX_FLAGS="-Wall -Wextra -Wpedantic -Werror -fprofile-arcs -ftest-coverage"
      -DCMAKE_BUILD_TYPE=Debug
      ..
    - make -j $(nproc)
    - make -j $(nproc) test
    - cmake --build . --target clang_format
    - git diff
    - if [[ $(git diff) ]]; then echo "Formatting is wrong! See above."; return 1; fi
    - cd ..
    - mkdir coverage_html
    - >
      gcovr build --gcov-executable 'llvm-cov-11 gcov' -f 'source/' -e '.*\.test\.cpp'
      --xml coverage.xml --xml-pretty --html-details coverage_html/index.html --print-summary
  artifacts:
    reports:
      cobertura: coverage.xml
    paths:
      - coverage_html/
    expire_in: 5 days

VC 16 Release:
  <<: *build_rules_definition
  image: buildtools2019:latest
  tags:
    - windows
  script:
    - mkdir -p build
    - cd build
    - 'cmake -G "Visual Studio 16 2019" -DCMAKE_CXX_FLAGS="/DWIN32 /D_WINDOWS /W3 /GR /EHsc /WX" -DENABLE_CLANG_TIDY=OFF ..'
    - 'cmake --build . --parallel --config Release --target ALL_BUILD'
    - 'cmake --build . --config Release --target RUN_TESTS'

variables:
  # Package version can only contain numbers (0-9), and dots (.).
  # Must be in the format of X.Y.Z, i.e. should match /\A\d+\.\d+\.\d+\z/ regular expresion.
  # See https://docs.gitlab.com/ee/user/packages/generic_packages/#publish-a-package-file
  TMIV_VERSION: "8.0.0"
  TEST_MODEL_HTML: "test_model_${TMIV_VERSION}.html"
  TEST_MODEL_PDF: "test_model_${TMIV_VERSION}.pdf"
  PACKAGE_REGISTRY_URL: "${CI_API_V4_URL}/projects/${CI_PROJECT_ID}/packages/generic/releases/${PACKAGE_VERSION}"

AsciiDoc:
  stage: build
  image: asciidoctor/docker-asciidoctor:1.2
  tags: [ linux ]
  rules:
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      changes:
        - doc/test_model/**/*
  script:
    - cd doc/test_model
    - asciidoctor --backend html5 -a data-uri index.adoc
    - mv index.html ../../${TEST_MODEL_HTML}
    - asciidoctor-pdf -r asciidoctor-mathematical -a pdf-style=pdf_theme.yml index.adoc
    - mv index.pdf ../../${TEST_MODEL_PDF}
  artifacts:
    paths:
      - ${TEST_MODEL_HTML}
      - ${TEST_MODEL_PDF}

upload:
  stage: upload
  image: curlimages/curl:latest
  tags: [ linux ]
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file ${TEST_MODEL_HTML} ${PACKAGE_REGISTRY_URL}/${TEST_MODEL_HTML}
    - |
      curl --header "JOB-TOKEN: ${CI_JOB_TOKEN}" --upload-file ${TEST_MODEL_PDF} ${PACKAGE_REGISTRY_URL}/${TEST_MODEL_PDF}

release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  tags: [ linux ]
  rules:
    - if: $CI_COMMIT_TAG
  script:
    - |
      release-cli create --name "Release $CI_COMMIT_TAG" --tag-name $CI_COMMIT_TAG \
        --assets-link "{\"name\":\"${TEST_MODEL_HTML}\",\"url\":\"${PACKAGE_REGISTRY_URL}/${TEST_MODEL_HTML}\"}" \
        --assets-link "{\"name\":\"${TEST_MODEL_PDF}\",\"url\":\"${PACKAGE_REGISTRY_URL}/${TEST_MODEL_PDF}\"}"
